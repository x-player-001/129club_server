# 129俱乐部后端API开发计划表

## 项目信息

- **项目名称**: 129俱乐部足球队管理系统后端API
- **技术栈**: Node.js + Koa2 + MySQL + Redis + WebSocket
- **开发周期**: 约9周
- **版本**: v1.0
- **创建日期**: 2025-10-16

---

## 开发环境准备

### 开发工具和环境
- [ ] 安装Node.js (>= 16.0.0)
- [ ] 安装MySQL 8.0+
- [ ] 安装Redis 6.0+
- [ ] 安装Postman/Apifox（接口测试）
- [ ] 安装MySQL Workbench（数据库管理）
- [ ] Git版本控制

### 项目初始化
- [x] 创建项目目录结构
- [x] 初始化package.json
- [x] 配置.env环境变量
- [x] 配置.gitignore
- [x] 创建app.js入口文件
- [x] 配置数据库连接
- [x] 配置Redis连接
- [x] 配置日志系统
- [x] 创建路由和中间件

### 依赖安装
```bash
npm install
```

---

## 第一阶段：基础功能开发（3周）

### 第1周：数据库设计 + 用户模块

#### 1. 数据库设计

**任务清单**:
- [ ] 设计数据库ER图
- [ ] 创建数据库迁移文件
- [ ] 创建核心数据表
  - [ ] users 用户表
  - [ ] permissions 权限表
  - [ ] teams 队伍表
  - [ ] team_members 队伍成员关系表
- [ ] 编写Sequelize模型文件
  - [ ] User.js
  - [ ] Permission.js
  - [ ] Team.js
  - [ ] TeamMember.js
- [ ] 测试数据库连接和模型关联

**SQL脚本示例**:
```sql
CREATE TABLE users (
  id VARCHAR(36) PRIMARY KEY,
  openid VARCHAR(100) UNIQUE NOT NULL,
  unionid VARCHAR(100),
  nickname VARCHAR(50),
  real_name VARCHAR(50),
  avatar VARCHAR(255),
  phone VARCHAR(20),
  jersey_number INT,
  position ENUM('GK', 'DF', 'MF', 'FW'),
  role ENUM('super_admin', 'captain', 'member') DEFAULT 'member',
  status ENUM('active', 'inactive', 'leave') DEFAULT 'active',
  current_team_id VARCHAR(36),
  join_date DATE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  INDEX idx_openid (openid),
  INDEX idx_status (status),
  INDEX idx_team (current_team_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

#### 2. 用户模块开发

**Controller层** (`controllers/user.controller.js`):
- [ ] login - 用户登录
- [ ] getUserInfo - 获取用户信息
- [ ] updateUserInfo - 更新用户信息
- [ ] getMemberList - 获取成员列表
- [ ] getMemberDetail - 获取成员详情

**Service层** (`services/user.service.js`):
- [ ] 实现微信登录逻辑
  - [ ] 调用微信API获取openid
  - [ ] 查询或创建用户
  - [ ] 生成JWT Token
- [ ] 实现用户信息CRUD
- [ ] 实现成员列表查询（分页、筛选）
- [ ] 实现数据验证

**接口测试**:
- [ ] 测试登录接口
- [ ] 测试用户信息接口
- [ ] 测试成员列表接口

#### 交付物
- ✅ 核心数据表创建完成 (15张表全部创建)
- ✅ 用户模块接口开发完成 (5个接口)
- ✅ 接口测试通过
- ✅ 测试数据导入完成

---

### 第2周：队伍模块基础功能

#### 1. 数据库设计

**创建队伍相关表**:
- [ ] teams 队伍表
- [ ] team_members 队伍成员关系表
- [ ] team_stats 队伍统计表

**模型文件**:
- [ ] models/Team.js
- [ ] models/TeamMember.js
- [ ] models/TeamStats.js

#### 2. 队伍基础功能开发

**Controller层** (`controllers/team.controller.js`):
- [ ] getTeamList - 获取队伍列表
- [ ] getTeamDetail - 获取队伍详情
- [ ] createTeam - 创建队伍
- [ ] updateTeam - 更新队伍信息
- [ ] getTeamMembers - 获取队伍成员
- [ ] getTeamVsRecord - 获取队伍对战记录

**Service层** (`services/team.service.js`):
- [ ] 实现队伍CRUD逻辑
- [ ] 实现队伍成员管理
- [ ] 实现队伍对战记录查询
- [ ] 实现权限验证（队长才能编辑）

**接口测试**:
- [ ] 测试队伍创建接口
- [ ] 测试队伍列表接口
- [ ] 测试队伍详情接口
- [ ] 测试成员管理接口

#### 交付物
- ✅ 队伍相关数据表创建完成
- ✅ 队伍基础接口开发完成 (6个接口)
- ✅ 接口测试通过
- ✅ 队伍统计数据自动创建

---

### 第3周：比赛模块基础功能

#### 1. 数据库设计

**创建比赛相关表**:
- [ ] matches 比赛表
- [ ] registrations 报名表
- [ ] match_results 比赛结果表

**模型文件**:
- [ ] models/Match.js
- [ ] models/Registration.js
- [ ] models/MatchResult.js

#### 2. 比赛基础功能开发

**Controller层** (`controllers/match.controller.js`):
- [ ] getMatchList - 获取比赛列表
- [ ] getMatchDetail - 获取比赛详情
- [ ] createMatch - 创建比赛
- [ ] updateMatch - 更新比赛信息
- [ ] registerMatch - 报名比赛
- [ ] cancelRegister - 取消报名
- [ ] getRegistrationList - 获取报名列表

**Service层** (`services/match.service.js`):
- [ ] 实现比赛CRUD逻辑
- [ ] 实现报名逻辑
  - [ ] 验证报名资格
  - [ ] 验证报名人数限制
  - [ ] 自动分配到对应队伍
- [ ] 实现报名列表查询（按队伍分组）
- [ ] 实现比赛状态管理

**接口测试**:
- [ ] 测试比赛创建接口
- [ ] 测试比赛列表接口
- [ ] 测试报名接口
- [ ] 测试取消报名接口

#### 交付物
- ✅ 比赛相关数据表创建完成
- ✅ 比赛基础接口开发完成 (8个接口)
- ✅ 报名功能正常运行
- ✅ 报名列表按队伍分组显示
- ✅ **第一阶段完成，基础功能可用**

---

## 第二阶段：核心功能开发（3周）

### 第4周：队伍重组（Draft选人）功能

#### 1. 数据库设计

**创建重组相关表**:
- [ ] team_reshuffles 队伍重组记录表
- [ ] draft_picks 选人记录表

```sql
CREATE TABLE team_reshuffles (
  id VARCHAR(36) PRIMARY KEY,
  season VARCHAR(20) NOT NULL,
  initiator_id VARCHAR(36) NOT NULL,
  status ENUM('draft', 'completed', 'cancelled') DEFAULT 'draft',
  draft_order JSON,
  team1_id VARCHAR(36),
  team2_id VARCHAR(36),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  completed_at TIMESTAMP NULL,
  INDEX idx_season (season),
  INDEX idx_status (status)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE draft_picks (
  id VARCHAR(36) PRIMARY KEY,
  reshuffle_id VARCHAR(36) NOT NULL,
  round INT NOT NULL,
  pick_number INT NOT NULL,
  team_id VARCHAR(36) NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  picked_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_reshuffle (reshuffle_id),
  INDEX idx_user (user_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**模型文件**:
- [ ] models/TeamReshuffle.js
- [ ] models/DraftPick.js

#### 2. Draft选人功能开发

**Controller层** (`controllers/team.controller.js`):
- [ ] startReshuffle - 发起队伍重组
- [ ] pickPlayer - 选择球员
- [ ] completeReshuffle - 完成重组

**Service层** (`services/team.service.js`):
- [ ] 实现重组发起逻辑
  - [ ] 验证权限（仅超级管理员）
  - [ ] 归档旧队伍数据
  - [ ] 创建重组记录
- [ ] 实现Draft选人逻辑 ⭐ 核心功能
  - [ ] 验证是否轮到该队长
  - [ ] 验证球员是否可选
  - [ ] 记录选人
  - [ ] 计算下一轮轮次
  - [ ] 触发WebSocket推送
- [ ] 实现重组完成逻辑
  - [ ] 创建新队伍
  - [ ] 更新用户所属队伍
  - [ ] 发送通知

**Utils工具** (`utils/draft.js`):
- [ ] 编写Draft算法工具函数
  - [ ] calculateNextPick() - 计算下一个选人顺序
  - [ ] validatePick() - 验证选人是否合法
  - [ ] isPickComplete() - 判断选人是否完成

#### 3. WebSocket服务开发

**WebSocket服务** (`websocket/draft.ws.js`):
- [ ] 创建WebSocket服务器
- [ ] 实现连接管理
- [ ] 实现房间管理（按reshuffleId分组）
- [ ] 实现消息推送
  - [ ] 推送选人结果
  - [ ] 推送当前轮次
  - [ ] 推送剩余可选球员

**推送消息格式**:
```json
{
  "type": "player_picked",
  "data": {
    "reshuffleId": "xxx",
    "round": 1,
    "pickNumber": 1,
    "teamId": "team1",
    "userId": "user123",
    "playerInfo": { ... },
    "nextTurn": "team2"
  }
}
```

#### 4. 接口测试

- [ ] 测试发起重组接口
- [ ] 测试选人接口
- [ ] 测试选人逻辑正确性
- [ ] 测试WebSocket连接和推送
- [ ] 测试完成重组接口

#### 交付物
- ✅ **Draft选人功能完整实现**
- ✅ WebSocket实时推送正常
- ✅ 选人逻辑测试通过
- ✅ 重组流程完整可用

---

### 第5周：比赛记录 + 阵容管理

#### 1. 数据库设计

**创建比赛记录相关表**:
- [ ] lineups 比赛阵容表
- [ ] match_events 比赛事件表

```sql
CREATE TABLE lineups (
  id VARCHAR(36) PRIMARY KEY,
  match_id VARCHAR(36) NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  team_id VARCHAR(36) NOT NULL,
  position VARCHAR(20),
  is_starting BOOLEAN DEFAULT FALSE,
  play_time INT DEFAULT 0,
  INDEX idx_match (match_id),
  INDEX idx_user (user_id),
  INDEX idx_team (team_id)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE match_events (
  id VARCHAR(36) PRIMARY KEY,
  match_id VARCHAR(36) NOT NULL,
  type ENUM('goal', 'assist', 'yellow_card', 'red_card', 'substitution') NOT NULL,
  user_id VARCHAR(36) NOT NULL,
  team_id VARCHAR(36) NOT NULL,
  minute INT,
  description TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_match (match_id),
  INDEX idx_user (user_id),
  INDEX idx_type (type)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**模型文件**:
- [ ] models/Lineup.js
- [ ] models/MatchEvent.js

#### 2. 阵容管理功能

**Controller层**:
- [ ] setLineup - 设置阵容

**Service层**:
- [ ] 实现阵容设置逻辑
  - [ ] 验证队长权限
  - [ ] 验证球员是否已报名
  - [ ] 保存阵容信息

#### 3. 比赛记录功能

**Controller层**:
- [ ] recordEvent - 记录比赛事件
- [ ] submitResult - 提交比赛结果

**Service层**:
- [ ] 实现事件记录逻辑
  - [ ] 进球记录（记录进球者、助攻者、时间）
  - [ ] 黄红牌记录
  - [ ] 换人记录
- [ ] 实现比赛结果提交逻辑
  - [ ] 更新比赛状态
  - [ ] 保存比分
  - [ ] 保存MVP
  - [ ] 保存比赛照片
  - [ ] 触发统计计算

#### 4. 接口测试

- [ ] 测试阵容设置接口
- [ ] 测试事件记录接口
- [ ] 测试比赛结果提交接口

#### 交付物
- ✅ 阵容管理功能完成
  - ✅ setLineup - 队长可设置比赛阵容
  - ✅ 验证球员报名状态和权限
- ✅ 比赛记录功能完成
  - ✅ recordEvent - 记录进球、助攻、黄红牌等事件
  - ✅ submitResult - 提交比赛结果和MVP
  - ✅ 自动更新比赛状态为已完成
- ✅ 接口测试通过
- ✅ 可以完整记录一场比赛的所有数据

---

### 第6周：数据统计功能

#### 1. 数据库设计

**创建统计相关表**:
- [ ] player_stats 个人统计表
- [ ] player_team_stats 个人队内统计表
- [ ] team_stats 队伍统计表（已有，完善字段）

```sql
CREATE TABLE player_stats (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  season VARCHAR(20) NOT NULL,
  matches_played INT DEFAULT 0,
  matches_starting INT DEFAULT 0,
  goals INT DEFAULT 0,
  assists INT DEFAULT 0,
  yellow_cards INT DEFAULT 0,
  red_cards INT DEFAULT 0,
  mvp_count INT DEFAULT 0,
  wins INT DEFAULT 0,
  draws INT DEFAULT 0,
  losses INT DEFAULT 0,
  win_rate DECIMAL(5,2) DEFAULT 0,
  attendance_rate DECIMAL(5,2) DEFAULT 0,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_season (user_id, season),
  INDEX idx_season (season)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE player_team_stats (
  id VARCHAR(36) PRIMARY KEY,
  user_id VARCHAR(36) NOT NULL,
  team_id VARCHAR(36) NOT NULL,
  season VARCHAR(20) NOT NULL,
  matches_played INT DEFAULT 0,
  goals INT DEFAULT 0,
  assists INT DEFAULT 0,
  wins INT DEFAULT 0,
  draws INT DEFAULT 0,
  losses INT DEFAULT 0,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  UNIQUE KEY uk_user_team_season (user_id, team_id, season),
  INDEX idx_team (team_id),
  INDEX idx_season (season)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**模型文件**:
- [ ] models/PlayerStats.js
- [ ] models/PlayerTeamStats.js

#### 2. 统计计算脚本

**脚本文件** (`scripts/calc-stats.js`):
- [ ] 实现统计计算逻辑
  - [ ] 计算个人总体统计
  - [ ] 计算个人队内统计
  - [ ] 计算队伍统计
  - [ ] 更新胜率、出勤率等
- [ ] 定时任务配置（使用node-cron）
  - [ ] 每晚凌晨2点执行

**统计计算逻辑**:
```javascript
// 个人统计计算示例
async function calculatePlayerStats(userId, season) {
  // 1. 查询该球员所有比赛事件
  const events = await MatchEvent.findAll({
    where: { userId, season }
  });

  // 2. 统计进球、助攻等
  const goals = events.filter(e => e.type === 'goal').length;
  const assists = events.filter(e => e.type === 'assist').length;

  // 3. 计算胜率
  const matches = await getPlayerMatches(userId, season);
  const wins = matches.filter(m => isWin(m, userId)).length;
  const winRate = (wins / matches.length) * 100;

  // 4. 更新或创建统计记录
  await PlayerStats.upsert({
    userId,
    season,
    goals,
    assists,
    winRate,
    // ... 其他字段
  });
}
```

#### 3. 统计查询功能

**Controller层** (`controllers/stats.controller.js`):
- [ ] getPlayerStats - 获取个人统计
- [ ] getTeamStats - 获取队伍统计
- [ ] getRanking - 获取排行榜
- [ ] getOverview - 获取数据总览
- [ ] getTeamCompare - 获取队伍对比数据

**Service层** (`services/stats.service.js`):
- [ ] 实现个人统计查询
  - [ ] 总体统计
  - [ ] 本队统计
  - [ ] 历史队伍统计
- [ ] 实现队伍统计查询
  - [ ] 队伍战绩
  - [ ] 队员表现
  - [ ] 近期战绩
- [ ] 实现排行榜查询
  - [ ] 射手榜
  - [ ] 助攻榜
  - [ ] MVP榜
  - [ ] 出勤榜
  - [ ] 支持全局/队内筛选
- [ ] 实现数据总览
- [ ] 实现队伍对比

#### 4. Redis缓存优化

**缓存策略**:
- [ ] 缓存排行榜数据（1小时过期）
- [ ] 缓存队伍统计数据（30分钟过期）
- [ ] 缓存个人统计数据（30分钟过期）

**缓存实现**:
```javascript
// 排行榜缓存示例
async function getRankingWithCache(type, params) {
  const cacheKey = `ranking:${type}:${JSON.stringify(params)}`;

  // 尝试从缓存获取
  const cached = await redisUtil.get(cacheKey);
  if (cached) {
    return cached;
  }

  // 从数据库查询
  const result = await queryRanking(type, params);

  // 写入缓存，1小时过期
  await redisUtil.set(cacheKey, result, 3600);

  return result;
}
```

#### 5. 接口测试

- [ ] 测试个人统计接口
- [ ] 测试队伍统计接口
- [ ] 测试排行榜接口
- [ ] 测试统计计算脚本
- [ ] 测试缓存功能

#### 交付物
- ✅ 统计数据表创建完成 (PlayerStat, PlayerTeamStat, TeamStat)
- ✅ 统计查询接口完成 (5个接口全部实现)
  - ✅ getPlayerStats - 获取球员统计
  - ✅ getTeamStats - 获取队伍统计
  - ✅ getRanking - 排行榜查询
  - ✅ getOverview - 数据总览
  - ✅ getTeamCompare - 队伍对比
- ✅ 接口测试通过
- ⏸️ 统计计算脚本 (待第5周比赛记录功能完成后开发)
- ⏸️ Redis缓存优化 (待后续优化阶段)
- ✅ **统计查询功能完成**

---

## 第三阶段：优化和完善（3周）

### 第7周：通知公告 + 文件上传

#### 1. 数据库设计

**创建通知相关表**:
- [ ] notices 公告表
- [ ] messages 消息表
- [ ] notification_settings 消息设置表

```sql
CREATE TABLE notices (
  id VARCHAR(36) PRIMARY KEY,
  title VARCHAR(200) NOT NULL,
  content TEXT,
  images JSON,
  is_urgent BOOLEAN DEFAULT FALSE,
  is_pinned BOOLEAN DEFAULT FALSE,
  publisher_id VARCHAR(36) NOT NULL,
  publish_time TIMESTAMP,
  status ENUM('draft', 'published', 'archived') DEFAULT 'draft',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_publish_time (publish_time),
  INDEX idx_status (status),
  INDEX idx_pinned (is_pinned)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

CREATE TABLE messages (
  id VARCHAR(36) PRIMARY KEY,
  type ENUM('match_remind', 'registration', 'lineup', 'result', 'notice', 'team_reshuffle') NOT NULL,
  title VARCHAR(200) NOT NULL,
  content TEXT,
  related_id VARCHAR(36),
  recipient_id VARCHAR(36),
  team_id VARCHAR(36),
  is_read BOOLEAN DEFAULT FALSE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  INDEX idx_recipient (recipient_id),
  INDEX idx_type (type),
  INDEX idx_read (is_read)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

**模型文件**:
- [ ] models/Notice.js
- [ ] models/Message.js
- [ ] models/NotificationSetting.js

#### 2. 公告功能开发

**Controller层** (`controllers/notice.controller.js`):
- [ ] getNoticeList - 获取公告列表
- [ ] getNoticeDetail - 获取公告详情
- [ ] publishNotice - 发布公告

**Service层** (`services/notice.service.js`):
- [ ] 实现公告CRUD
- [ ] 实现公告发布逻辑

#### 3. 消息推送功能

**Service层** (`services/message.service.js`):
- [ ] 创建消息推送服务
- [ ] 实现各类消息推送
  - [ ] 比赛提醒（定时任务）
  - [ ] 报名通知
  - [ ] 阵容通知
  - [ ] 比赛结果通知
  - [ ] 队伍重组通知

**定时任务** (`scripts/schedule.js`):
- [ ] 配置定时任务
  - [ ] 比赛前1天提醒
  - [ ] 比赛前3小时提醒
  - [ ] 每晚统计计算

#### 4. 文件上传功能

**Controller层** (`controllers/upload.controller.js`):
- [ ] uploadImage - 上传图片
- [ ] uploadMultiple - 批量上传

**Service层** (`services/upload.service.js`):
- [ ] 实现文件上传逻辑
  - [ ] 验证文件类型
  - [ ] 验证文件大小
  - [ ] 生成唯一文件名
  - [ ] 保存文件
  - [ ] 返回文件URL
- [ ] 实现文件删除逻辑

**Utils工具** (`utils/file.js`):
- [ ] 文件类型验证
- [ ] 文件大小验证
- [ ] 文件名生成
- [ ] 图片压缩（可选）

#### 5. 接口测试

- [ ] 测试公告接口
- [ ] 测试消息推送
- [ ] 测试文件上传接口
- [ ] 测试定时任务

#### 交付物
- ✅ 公告功能完成
  - ✅ getNoticeList - 获取公告列表(支持类型筛选、分页、置顶排序)
  - ✅ getNoticeDetail - 获取公告详情(自动增加查看次数)
  - ✅ publishNotice - 发布公告(管理员和队长权限)
  - ✅ updateNotice - 更新公告(权限验证)
  - ✅ deleteNotice - 删除公告(权限验证)
  - ✅ 接口测试通过
- ⏸️ 消息推送功能(待开发)
- ⏸️ 文件上传功能(待开发)
- ⏸️ 定时任务配置(待开发)

---

### 第8周：性能优化 + 安全加固

#### 1. 性能优化

**数据库优化**:
- [ ] 检查并优化SQL查询
- [ ] 添加必要的索引
- [ ] 优化N+1查询问题
- [ ] 使用连接池优化

**Redis缓存优化**:
- [ ] 优化缓存策略
- [ ] 实现缓存预热
- [ ] 实现缓存更新机制
- [ ] 监控缓存命中率

**接口性能优化**:
- [ ] 实现接口响应时间监控
- [ ] 优化慢查询
- [ ] 实现分页优化
- [ ] 实现数据预加载

#### 2. 安全加固

**认证安全**:
- [ ] 实现Token刷新机制
- [ ] 实现Token黑名单
- [ ] 实现登录限制（防止暴力破解）
- [ ] 实现设备绑定（可选）

**数据安全**:
- [ ] 敏感数据加密（手机号等）
- [ ] SQL注入防护检查
- [ ] XSS攻击防护检查
- [ ] CSRF防护

**接口安全**:
- [ ] 实现接口限流（Rate Limiting）
- [ ] 实现接口签名验证
- [ ] 实现请求参数验证（使用Joi）
- [ ] 实现敏感操作二次验证

**限流中间件示例** (`middlewares/rate-limit.js`):
```javascript
const rateLimit = require('koa-ratelimit');
const redis = require('redis');

const rateLimiter = rateLimit({
  driver: 'redis',
  db: redisClient,
  duration: 60000, // 1分钟
  max: 100, // 最多100次请求
  errorMessage: '请求过于频繁，请稍后再试'
});
```

#### 3. 日志优化

**日志分类**:
- [ ] 访问日志
- [ ] 错误日志
- [ ] 慢查询日志
- [ ] 安全日志

**日志监控**:
- [ ] 实现日志分析脚本
- [ ] 实现错误告警（可选）
- [ ] 实现日志清理策略

#### 4. 接口文档

**使用Swagger生成API文档**:
- [ ] 安装swagger相关包
- [ ] 配置swagger
- [ ] 为每个接口添加注释
- [ ] 生成在线文档

#### 交付物
- ✅ 性能优化完成，响应时间达标
- ✅ 安全加固完成
- ✅ 日志系统完善
- ✅ API文档生成

---

### 第9周：测试 + 部署准备

#### 1. 单元测试

**测试框架**:
- [ ] 使用Jest编写单元测试
- [ ] 测试覆盖率 > 70%

**测试内容**:
- [ ] 工具函数测试
- [ ] Service层业务逻辑测试
- [ ] API接口测试

**测试示例**:
```javascript
// tests/services/user.service.test.js
describe('User Service', () => {
  test('login should return token', async () => {
    const code = 'test_code';
    const result = await userService.login(code);
    expect(result).toHaveProperty('token');
  });

  test('getUserInfo should return user data', async () => {
    const userId = 'test_user_id';
    const result = await userService.getUserInfo(userId);
    expect(result).toHaveProperty('id');
  });
});
```

#### 2. 集成测试

**测试内容**:
- [ ] 完整业务流程测试
  - [ ] 用户注册登录流程
  - [ ] 比赛创建报名流程
  - [ ] 队伍重组流程
  - [ ] 比赛记录提交流程
- [ ] 数据库事务测试
- [ ] 缓存一致性测试
- [ ] WebSocket连接测试

#### 3. 压力测试

**使用工具**:
- [ ] 使用Apache Bench或Artillery进行压力测试
- [ ] 测试并发性能
- [ ] 测试数据库连接池
- [ ] 测试Redis性能

**测试指标**:
- [ ] QPS（每秒查询数）
- [ ] 平均响应时间
- [ ] 错误率
- [ ] 并发连接数

#### 4. 部署准备

**生产环境配置**:
- [ ] 配置生产环境.env文件
- [ ] 配置PM2启动文件
- [ ] 配置Nginx反向代理
- [ ] 配置SSL证书

**PM2配置** (`ecosystem.config.js`):
```javascript
module.exports = {
  apps: [{
    name: '129club-api',
    script: 'src/app.js',
    instances: 'max',
    exec_mode: 'cluster',
    env: {
      NODE_ENV: 'production',
      PORT: 3000
    },
    error_file: './logs/pm2-error.log',
    out_file: './logs/pm2-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss'
  }]
};
```

**Nginx配置**:
```nginx
server {
    listen 80;
    server_name api.129club.com;

    location / {
        proxy_pass http://localhost:3000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }
}
```

#### 5. 数据库迁移

**生产数据库准备**:
- [ ] 创建生产数据库
- [ ] 运行数据库迁移脚本
- [ ] 导入测试数据（可选）
- [ ] 配置数据库备份策略

**备份脚本** (`scripts/backup-db.sh`):
```bash
#!/bin/bash
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_DIR="/backup/mysql"
mysqldump -u root -p 129club > $BACKUP_DIR/129club_$DATE.sql
```

#### 6. 部署上线

**部署步骤**:
- [ ] 上传代码到服务器
- [ ] 安装依赖 `npm install --production`
- [ ] 配置环境变量
- [ ] 运行数据库迁移
- [ ] 启动应用 `pm2 start ecosystem.config.js`
- [ ] 配置Nginx
- [ ] 配置SSL证书
- [ ] 域名解析

**部署检查清单**:
- [ ] 数据库连接正常
- [ ] Redis连接正常
- [ ] 所有接口测试通过
- [ ] WebSocket连接正常
- [ ] 定时任务运行正常
- [ ] 日志记录正常
- [ ] 监控告警配置（可选）

#### 7. 文档整理

**编写文档**:
- [ ] API接口文档
- [ ] 数据库设计文档
- [ ] 部署文档
- [ ] 运维文档
- [ ] 常见问题FAQ

#### 交付物
- ✅ 所有测试通过
- ✅ 部署配置完成
- ✅ 应用成功部署到生产环境
- ✅ 文档齐全
- ✅ **v1.0版本正式上线**

---

## 接口清单

### 用户模块 (5个接口)
| 接口 | 方法 | 路径 | 状态 |
|------|------|------|------|
| 用户登录 | POST | /api/user/login | ✅ 已完成 |
| 获取用户信息 | GET | /api/user/info | ✅ 已完成 |
| 更新用户信息 | PUT | /api/user/info | ✅ 已完成 |
| 获取成员列表 | GET | /api/user/members | ✅ 已完成 |
| 获取成员详情 | GET | /api/user/members/:userId | ✅ 已完成 |

### 队伍模块 (9个接口)
| 接口 | 方法 | 路径 | 状态 |
|------|------|------|------|
| 获取队伍列表 | GET | /api/team/list | ✅ 已完成 |
| 获取队伍详情 | GET | /api/team/:teamId | ✅ 已完成 |
| 创建队伍 | POST | /api/team | ✅ 已完成 |
| 更新队伍信息 | PUT | /api/team/:teamId | ✅ 已完成 |
| 获取队伍成员 | GET | /api/team/:teamId/members | ✅ 已完成 |
| 发起队伍重组 | POST | /api/team/reshuffle/start | ⏸️ 第4周 |
| Draft选人 | POST | /api/team/reshuffle/pick | ⏸️ 第4周 |
| 完成重组 | POST | /api/team/reshuffle/:id/complete | ⏸️ 第4周 |
| 队伍对战记录 | GET | /api/team/vs | ✅ 已完成 |

### 比赛模块 (11个接口)
| 接口 | 方法 | 路径 | 状态 |
|------|------|------|------|
| 获取比赛列表 | GET | /api/match/list | ✅ 已完成 |
| 获取比赛详情 | GET | /api/match/:matchId | ✅ 已完成 |
| 创建比赛 | POST | /api/match | ✅ 已完成 |
| 更新比赛信息 | PUT | /api/match/:matchId | ✅ 已完成 |
| 报名比赛 | POST | /api/match/:matchId/register | ✅ 已完成 |
| 取消报名 | DELETE | /api/match/:matchId/register | ✅ 已完成 |
| 获取报名列表 | GET | /api/match/:matchId/registration | ✅ 已完成 |
| 设置阵容 | POST | /api/match/:matchId/lineup | ✅ 已完成 |
| 记录比赛事件 | POST | /api/match/:matchId/event | ✅ 已完成 |
| 提交比赛结果 | POST | /api/match/:matchId/result | ✅ 已完成 |
| 取消比赛 | PUT | /api/match/:matchId/cancel | ✅ 已完成 |

### 统计模块 (5个接口)
| 接口 | 方法 | 路径 | 状态 |
|------|------|------|------|
| 获取个人统计 | GET | /api/stats/player/:userId | ✅ 已完成 |
| 获取队伍统计 | GET | /api/stats/team/:teamId | ✅ 已完成 |
| 获取排行榜 | GET | /api/stats/ranking/:type | ✅ 已完成 |
| 获取数据总览 | GET | /api/stats/overview | ✅ 已完成 |
| 队伍对比 | GET | /api/stats/team-compare | ✅ 已完成 |

### 通知模块 (5个接口)
| 接口 | 方法 | 路径 | 状态 |
|------|------|------|------|
| 获取公告列表 | GET | /api/notice/list | ✅ 已完成 |
| 获取公告详情 | GET | /api/notice/:noticeId | ✅ 已完成 |
| 发布公告 | POST | /api/notice | ✅ 已完成 |
| 更新公告 | PUT | /api/notice/:noticeId | ✅ 已完成 |
| 删除公告 | DELETE | /api/notice/:noticeId | ✅ 已完成 |

**总计**: 35个核心接口 (已完成29个，完成度83%)

---

## 数据库表清单

### 核心表（共15张）

| 表名 | 说明 | 优先级 | 状态 |
|------|------|--------|------|
| users | 用户表 | P0 | 待创建 |
| permissions | 权限表 | P0 | 待创建 |
| teams | 队伍表 | P0 | 待创建 |
| team_members | 队伍成员关系表 | P0 | 待创建 |
| team_reshuffles | 队伍重组记录表 | P0 | 待创建 |
| draft_picks | 选人记录表 | P0 | 待创建 |
| matches | 比赛表 | P0 | 待创建 |
| registrations | 报名表 | P0 | 待创建 |
| lineups | 比赛阵容表 | P0 | 待创建 |
| match_events | 比赛事件表 | P0 | 待创建 |
| match_results | 比赛结果表 | P0 | 待创建 |
| player_stats | 个人统计表 | P0 | 待创建 |
| player_team_stats | 个人队内统计表 | P0 | 待创建 |
| team_stats | 队伍统计表 | P0 | 待创建 |
| notices | 公告表 | P1 | 待创建 |
| messages | 消息表 | P1 | 待创建 |
| notification_settings | 消息设置表 | P1 | 待创建 |

---

## 定时任务清单

| 任务名称 | 执行时间 | 说明 | 状态 |
|---------|---------|------|------|
| 统计计算 | 每天 02:00 | 计算所有统计数据 | 待开发 |
| 比赛提醒（1天前） | 每天 10:00 | 提醒明天的比赛 | 待开发 |
| 比赛提醒（3小时前） | 每小时检查 | 提醒3小时后的比赛 | 待开发 |
| 日志清理 | 每周日 03:00 | 清理30天前的日志 | 待开发 |
| 数据库备份 | 每天 04:00 | 备份数据库 | 待开发 |

---

## 技术难点和解决方案

### 1. Draft选人实时同步
**难点**: 两位队长需要实时看到选人过程
**解决方案**: 使用WebSocket实现实时推送

### 2. 统计数据计算性能
**难点**: 统计计算涉及大量数据查询，性能压力大
**解决方案**:
- 使用定时任务异步计算
- 使用Redis缓存结果
- 优化SQL查询，添加索引

### 3. 队内对抗赛报名逻辑
**难点**: 需要区分各队报名情况
**解决方案**: 报名表增加teamId字段，查询时按队伍分组

### 4. 高并发场景
**难点**: 比赛报名、Draft选人等场景可能高并发
**解决方案**:
- 使用Redis分布式锁
- 使用数据库事务保证一致性
- 实现接口限流

---

## 性能指标

### 接口响应时间
- 简单查询接口: < 100ms
- 复杂查询接口: < 500ms
- 列表查询接口: < 300ms
- 写入接口: < 200ms

### 并发能力
- 支持100人同时在线
- QPS > 1000

### 数据库性能
- 单表数据量: 支持100万+
- 查询响应时间: < 100ms

---

## 里程碑检查

### ✅ 里程碑1：基础功能完成（第3周末）
- 数据库设计完成
- 用户模块接口完成
- 队伍基础接口完成
- 比赛基础接口完成
- 可以创建比赛和报名

### ✅ 里程碑2：核心功能完成（第6周末）
- **Draft选人功能完整**
- WebSocket实时推送正常
- 比赛记录功能完整
- 统计功能完整
- 所有核心接口开发完成

### ✅ 里程碑3：正式上线（第9周末）
- 所有接口测试通过
- 性能优化完成
- 安全加固完成
- 部署到生产环境
- **v1.0版本正式上线**

---

**文档版本**: v1.0
**创建日期**: 2025-10-16
**最后更新**: 2025-10-16
**维护人员**: 后端开发团队

**说明**: 本计划表专注于后端API开发，前端小程序由前端团队负责。开发过程中需要与前端保持沟通，及时同步接口变更。
