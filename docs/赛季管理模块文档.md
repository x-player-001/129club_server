# 赛季管理模块文档

## 📋 目录

- [模块概述](#模块概述)
- [数据模型](#数据模型)
- [API接口](#api接口)
- [业务逻辑](#业务逻辑)
- [使用示例](#使用示例)

---

## 模块概述

赛季管理模块用于管理足球比赛的赛季信息，支持：
- 赛季的创建、查询、更新、删除
- 赛季状态管理（即将开始、进行中、已完成、已归档）
- 赛季比赛关联与数量限制
- 赛季统计与积分排名
- 历史赛季数据查询

### 核心特性

✅ **灵活的赛季配置**：赛季长度可配置，不限制比赛场数
✅ **状态生命周期管理**：upcoming → active → completed → archived
✅ **比赛关联**：创建比赛时可指定所属赛季
✅ **自动统计**：自动计算赛季内队伍积分和排名
✅ **数据隔离**：每个赛季的数据独立管理，支持历史数据查询

---

## 数据模型

### Season 表结构

| 字段名 | 类型 | 必填 | 默认值 | 说明 |
|--------|------|------|--------|------|
| id | UUID | 是 | 自动生成 | 赛季ID |
| name | VARCHAR(50) | 是 | - | 赛季名称，唯一，如"2025-S1" |
| title | VARCHAR(100) | 否 | NULL | 赛季标题 |
| description | TEXT | 否 | NULL | 赛季说明 |
| start_date | DATETIME | 否 | NULL | 赛季开始日期 |
| end_date | DATETIME | 否 | NULL | 赛季结束日期 |
| max_matches | INT | 否 | 10 | 赛季最大比赛场数 |
| status | ENUM | 否 | 'upcoming' | 赛季状态 |
| created_by | UUID | 否 | NULL | 创建者ID |
| created_at | DATETIME | 否 | NOW() | 创建时间 |
| completed_at | DATETIME | 否 | NULL | 完成时间 |

### 赛季状态说明

| 状态 | 值 | 说明 |
|------|-----|------|
| 即将开始 | `upcoming` | 赛季已创建但未开始 |
| 进行中 | `active` | 赛季正在进行，可以添加比赛 |
| 已完成 | `completed` | 赛季已结束，不能添加比赛 |
| 已归档 | `archived` | 赛季已归档，不能添加比赛 |

### Match 表关联字段

在 `matches` 表中新增字段：

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| season_id | UUID | 否 | 所属赛季ID，外键关联seasons.id |

---

## API接口

### 基础路径

```
/api/season
```

所有接口都需要用户登录认证（需要携带 token）。

---

### 1. 创建赛季

**接口地址：** `POST /api/season`

**请求参数：**

```json
{
  "name": "2025-S1",           // 必填，赛季名称（唯一）
  "title": "2025年第一赛季",    // 可选，赛季标题
  "description": "春季联赛",    // 可选，赛季说明
  "startDate": "2025-01-01",   // 可选，开始日期
  "endDate": "2025-06-30",     // 可选，结束日期
  "maxMatches": 10             // 可选，最大比赛场数，默认10
}
```

**响应示例：**

```json
{
  "code": 0,
  "success": true,
  "message": "创建成功",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "2025-S1",
    "title": "2025年第一赛季",
    "description": "春季联赛",
    "startDate": "2025-01-01T00:00:00.000Z",
    "endDate": "2025-06-30T00:00:00.000Z",
    "maxMatches": 10,
    "status": "upcoming",
    "createdBy": "user-uuid",
    "createdAt": "2025-10-18T10:00:00.000Z",
    "completedAt": null
  }
}
```

**错误响应：**

- 赛季名称已存在：`{ "code": 1, "message": "赛季名称已存在" }`

---

### 2. 获取赛季列表

**接口地址：** `GET /api/season/list`

**查询参数：**

| 参数 | 类型 | 必填 | 说明 |
|------|------|------|------|
| status | string | 否 | 筛选状态：upcoming/active/completed/archived |
| page | number | 否 | 页码，默认1 |
| limit | number | 否 | 每页数量，默认20 |

**请求示例：**

```
GET /api/season/list?status=active&page=1&limit=10
```

**响应示例：**

```json
{
  "code": 0,
  "success": true,
  "data": {
    "list": [
      {
        "id": "550e8400-e29b-41d4-a716-446655440000",
        "name": "2025-S1",
        "title": "2025年第一赛季",
        "description": "春季联赛",
        "startDate": "2025-01-01T00:00:00.000Z",
        "endDate": "2025-06-30T00:00:00.000Z",
        "maxMatches": 10,
        "status": "active",
        "createdAt": "2025-10-18T10:00:00.000Z"
      }
    ],
    "total": 1,
    "page": 1,
    "limit": 10,
    "totalPages": 1
  }
}
```

---

### 3. 获取赛季详情

**接口地址：** `GET /api/season/:seasonId/detail`

**路径参数：**

- `seasonId`：赛季ID

**响应示例：**

```json
{
  "code": 0,
  "success": true,
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "2025-S1",
    "title": "2025年第一赛季",
    "description": "春季联赛",
    "startDate": "2025-01-01T00:00:00.000Z",
    "endDate": "2025-06-30T00:00:00.000Z",
    "maxMatches": 10,
    "status": "active",
    "createdAt": "2025-10-18T10:00:00.000Z",
    "matches": [
      {
        "id": "match-uuid-1",
        "title": "红队 vs 蓝队",
        "matchDate": "2025-03-15T10:00:00.000Z",
        "status": "completed",
        "team1": {
          "id": "team-uuid-1",
          "name": "红队",
          "logo": "https://example.com/red-logo.png"
        },
        "team2": {
          "id": "team-uuid-2",
          "name": "蓝队",
          "logo": "https://example.com/blue-logo.png"
        }
      }
    ],
    "matchCount": 1
  }
}
```

**错误响应：**

- 赛季不存在：`{ "code": 1, "message": "赛季不存在" }`

---

### 4. 获取赛季统计

**接口地址：** `GET /api/season/:seasonId/statistics`

**路径参数：**

- `seasonId`：赛季ID

**响应示例：**

```json
{
  "code": 0,
  "success": true,
  "data": {
    "season": {
      "id": "550e8400-e29b-41d4-a716-446655440000",
      "name": "2025-S1",
      "title": "2025年第一赛季"
    },
    "totalMatches": 8,
    "completedMatches": 8,
    "rankings": [
      {
        "teamId": "team-uuid-1",
        "teamName": "红队",
        "teamLogo": "https://example.com/red-logo.png",
        "totalScore": 15,      // 总积分（4节制累计分数 或 传统制：赢3分、平1分、输0分）
        "totalGoals": 24,      // 总进球数
        "matchCount": 8,       // 参赛场数
        "winCount": 5,         // 胜场数
        "loseCount": 3         // 负场数
      },
      {
        "teamId": "team-uuid-2",
        "teamName": "蓝队",
        "teamLogo": "https://example.com/blue-logo.png",
        "totalScore": 12,
        "totalGoals": 18,
        "matchCount": 8,
        "winCount": 4,
        "loseCount": 4
      }
    ]
  }
}
```

**积分规则说明：**

- **4节制比赛**：使用 `match_results` 表中的 `team1_final_score` 和 `team2_final_score`（每节胜利获得的积分累加）
- **传统制比赛**：赢得比赛 = 3分，平局 = 1分，输 = 0分

**排名规则：**

1. 按总积分降序
2. 积分相同时按总进球数降序

---

### 5. 更新赛季信息

**接口地址：** `PUT /api/season/:seasonId`

**路径参数：**

- `seasonId`：赛季ID

**请求参数：**

```json
{
  "title": "2025年春季联赛",     // 可选
  "description": "更新后的说明", // 可选
  "startDate": "2025-01-15",    // 可选
  "endDate": "2025-07-15",      // 可选
  "maxMatches": 15,             // 可选
  "status": "active"            // 可选：upcoming/active/completed/archived
}
```

**响应示例：**

```json
{
  "code": 0,
  "success": true,
  "message": "更新成功",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "2025-S1",
    "title": "2025年春季联赛",
    "description": "更新后的说明",
    "startDate": "2025-01-15T00:00:00.000Z",
    "endDate": "2025-07-15T00:00:00.000Z",
    "maxMatches": 15,
    "status": "active",
    "completedAt": null
  }
}
```

**注意事项：**

- 当状态更新为 `completed` 时，会自动设置 `completedAt` 为当前时间
- 不能修改赛季名称 `name`（唯一标识）

---

### 6. 激活赛季

**接口地址：** `POST /api/season/:seasonId/activate`

**路径参数：**

- `seasonId`：赛季ID

**响应示例：**

```json
{
  "code": 0,
  "success": true,
  "message": "赛季已激活",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "2025-S1",
    "status": "active"
  }
}
```

**错误响应：**

- 赛季已经是激活状态：`{ "code": 1, "message": "赛季已经是激活状态" }`

---

### 7. 完成赛季

**接口地址：** `POST /api/season/:seasonId/complete`

**路径参数：**

- `seasonId`：赛季ID

**响应示例：**

```json
{
  "code": 0,
  "success": true,
  "message": "赛季已完成",
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "2025-S1",
    "status": "completed",
    "completedAt": "2025-10-18T12:00:00.000Z"
  }
}
```

**注意事项：**

- 完成后的赛季无法再添加新比赛
- 会自动设置 `completedAt` 为当前时间

---

### 8. 删除赛季

**接口地址：** `DELETE /api/season/:seasonId`

**路径参数：**

- `seasonId`：赛季ID

**响应示例：**

```json
{
  "code": 0,
  "success": true,
  "data": {
    "message": "赛季已删除"
  }
}
```

**错误响应：**

- 赛季有关联比赛：`{ "code": 1, "message": "该赛季有5场比赛，无法删除。请先删除或移除比赛的赛季关联。" }`

---

## 业务逻辑

### 创建比赛时关联赛季

在创建比赛时，可以通过 `seasonId` 参数将比赛关联到赛季：

**接口：** `POST /api/match`

**请求参数：**

```json
{
  "title": "红队 vs 蓝队",
  "team1Id": "team-uuid-1",
  "team2Id": "team-uuid-2",
  "matchDate": "2025-03-15 14:00:00",
  "location": "市体育场",
  "description": "第三轮比赛",
  "seasonId": "550e8400-e29b-41d4-a716-446655440000",  // 赛季ID（可选）
  "quarterSystem": true,
  "maxPlayersPerTeam": 8
}
```

### 赛季比赛数量限制

创建比赛时会自动验证：

1. **赛季是否存在**：如果 `seasonId` 无效，返回错误
2. **赛季状态检查**：
   - ✅ `upcoming` 或 `active` 状态：可以添加比赛
   - ❌ `completed` 或 `archived` 状态：不能添加比赛
3. **比赛数量限制**：
   - 如果设置了 `maxMatches`，当达到上限时无法创建新比赛
   - 错误示例：`{ "code": 1, "message": "赛季比赛数已达上限（10场）" }`

### 赛季统计逻辑

#### 积分计算

**4节制比赛（quarterSystem = true）：**
- 使用 `match_results.team1_final_score` 和 `team2_final_score`
- 这些分数已经是每节积分的累加（Q1和Q2胜利各1分，Q3和Q4胜利各2分）

**传统制比赛（quarterSystem = false）：**
- 赢得比赛（进球多）= 3分
- 平局（进球相同）= 1分
- 输掉比赛 = 0分

#### 排名规则

1. 按 `totalScore`（总积分）降序排列
2. 如果积分相同，按 `totalGoals`（总进球数）降序排列

---

## 使用示例

### 完整流程示例

#### 1. 创建新赛季

```bash
POST /api/season
Content-Type: application/json
Authorization: Bearer <token>

{
  "name": "2025-S1",
  "title": "2025年春季联赛",
  "description": "129俱乐部2025年第一赛季",
  "startDate": "2025-01-01",
  "endDate": "2025-06-30",
  "maxMatches": 10
}
```

#### 2. 激活赛季

```bash
POST /api/season/550e8400-e29b-41d4-a716-446655440000/activate
Authorization: Bearer <token>
```

#### 3. 创建赛季比赛

```bash
POST /api/match
Content-Type: application/json
Authorization: Bearer <token>

{
  "title": "红队 vs 蓝队",
  "team1Id": "team-uuid-1",
  "team2Id": "team-uuid-2",
  "matchDate": "2025-03-15 14:00:00",
  "location": "市体育场",
  "seasonId": "550e8400-e29b-41d4-a716-446655440000",
  "quarterSystem": true
}
```

#### 4. 查看赛季详情

```bash
GET /api/season/550e8400-e29b-41d4-a716-446655440000/detail
Authorization: Bearer <token>
```

#### 5. 查看赛季统计和排名

```bash
GET /api/season/550e8400-e29b-41d4-a716-446655440000/statistics
Authorization: Bearer <token>
```

#### 6. 赛季结束后标记完成

```bash
POST /api/season/550e8400-e29b-41d4-a716-446655440000/complete
Authorization: Bearer <token>
```

---

## 数据库关系

```
┌─────────────┐
│   seasons   │
│             │
│ - id (PK)   │
│ - name      │
│ - title     │
│ - status    │
└──────┬──────┘
       │
       │ 1:N
       │
       ▼
┌─────────────┐
│   matches   │
│             │
│ - id (PK)   │
│ - season_id │◄─── 外键
│ - team1_id  │
│ - team2_id  │
└─────────────┘
```

**外键约束：**
- `matches.season_id` → `seasons.id`
- 删除策略：`ON DELETE SET NULL`（删除赛季时，比赛的 season_id 设为 NULL）
- 更新策略：`ON UPDATE CASCADE`（更新赛季ID时，级联更新）

---

## 常见问题

### Q1：可以修改赛季的最大比赛场数吗？

可以。通过 `PUT /api/season/:seasonId` 接口更新 `maxMatches` 字段。但如果当前比赛数已经超过新的限制，不会影响已有比赛，只会限制新增比赛。

### Q2：删除赛季后，关联的比赛会被删除吗？

不会。删除赛季时，关联比赛的 `season_id` 会被设置为 `NULL`，比赛数据不会丢失。

### Q3：如何查询某个赛季的所有比赛？

方式1：使用赛季详情接口 `GET /api/season/:seasonId/detail`，返回数据中包含 `matches` 数组。

方式2：使用比赛列表接口 `GET /api/match/list?seasonId=xxx`（需要在 match.service.js 中添加 seasonId 查询支持）。

### Q4：赛季完成后还能修改信息吗？

可以修改除 `status` 以外的字段（如 title、description）。但不建议修改已完成赛季的关键信息。

### Q5：如何实现"赛季结束后重新组建队伍"？

这个功能已经存在于 `TeamReshuffle` 模块中。流程：
1. 完成当前赛季：`POST /api/season/:seasonId/complete`
2. 创建新赛季：`POST /api/season`
3. 发起队伍重组：使用 `/api/team/reshuffle` 相关接口
4. Draft选人完成后，新队伍关联到新赛季

---

## 版本历史

- **v1.0.0** (2025-10-18)
  - 初始版本发布
  - 支持赛季CRUD操作
  - 支持赛季统计和排名
  - 支持比赛关联赛季

---

## 技术支持

如有问题，请查看主文档 `API文档.md` 或联系开发团队。
