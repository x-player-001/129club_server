# 乌龙球功能说明文档

## 功能概述

系统现已支持记录乌龙球（Own Goal）以及其他各种进球类型。通过 `event_subtype` 字段，可以记录进球的详细方式。

## 数据库设计

### match_events 表新增字段

```sql
event_subtype VARCHAR(50) NULL
COMMENT '事件子类型（own_goal=乌龙球, penalty=点球, free_kick=任意球, header=头球等）'
```

### 设计优势

✅ **高扩展性**：可以无限添加新的子类型，无需修改表结构
✅ **层次清晰**：`event_type` 是大类，`event_subtype` 是细分
✅ **灵活查询**：可以查询所有进球，或特定类型的进球
✅ **支持组合**：同一个事件类型可以有多种子类型

## 支持的事件子类型

### 进球类型 (`event_type = 'goal'`)

| event_subtype | 中文名称 | 说明 |
|---------------|---------|------|
| `own_goal` | 乌龙球 | 球员将球踢进自己球门 |
| `penalty` | 点球 | 12码点球 |
| `free_kick` | 任意球 | 直接任意球破门 |
| `corner_kick` | 角球 | 角球直接破门 |
| `header` | 头球 | 头球进球 |
| `volley` | 凌空抽射 | 凌空抽射进球 |
| `bicycle_kick` | 倒钩 | 倒钩进球 |
| `long_shot` | 远射 | 距离球门较远的射门 |
| `null` | 普通进球 | 未指定子类型的进球 |

### 犯规类型 (`event_type = 'yellow_card'` / `'red_card'`)

| event_subtype | 中文名称 | 说明 |
|---------------|---------|------|
| `foul` | 犯规 | 一般犯规 |
| `diving` | 假摔 | 假摔骗牌 |
| `dissent` | 异议 | 对裁判判罚表示异议 |
| `violent_conduct` | 暴力行为 | 暴力行为 |
| `second_yellow` | 两黄变红 | 第二张黄牌累计红牌 |

## API 使用示例

### 1. 记录乌龙球

```javascript
POST /api/match/:matchId/event

{
  "teamId": "ball-owner-team-id",     // 踢乌龙球球员所在的队伍
  "userId": "player-user-id",          // 踢乌龙球的球员ID
  "eventType": "goal",                 // 事件类型：进球
  "eventSubtype": "own_goal",          // 子类型：乌龙球
  "minute": 35,
  "notes": "禁区内解围失误"
}
```

**重要**：
- `teamId` 是踢乌龙球球员**自己的队伍ID**（不是进球方）
- 乌龙球计入对方比分，但不计入该球员的进球数

### 2. 记录点球

```javascript
POST /api/match/:matchId/event

{
  "teamId": "team-id",
  "userId": "player-user-id",
  "eventType": "goal",
  "eventSubtype": "penalty",           // 子类型：点球
  "minute": 78,
  "assistUserId": null,                // 点球通常没有助攻
  "notes": "点球命中"
}
```

### 3. 记录头球

```javascript
POST /api/match/:matchId/event

{
  "teamId": "team-id",
  "userId": "player-user-id",
  "eventType": "goal",
  "eventSubtype": "header",            // 子类型：头球
  "minute": 15,
  "assistUserId": "assist-player-id",
  "notes": "角球头球攻门"
}
```

### 4. 记录普通进球（无子类型）

```javascript
POST /api/match/:matchId/event

{
  "teamId": "team-id",
  "userId": "player-user-id",
  "eventType": "goal",
  "eventSubtype": null,                // 或者不传此字段
  "minute": 42,
  "assistUserId": "assist-player-id"
}
```

## 查询示例

### 查询所有进球（包括乌龙球）

```javascript
const allGoals = await MatchEvent.findAll({
  where: {
    matchId: matchId,
    eventType: 'goal'
  }
});
```

### 只查询乌龙球

```javascript
const ownGoals = await MatchEvent.findAll({
  where: {
    matchId: matchId,
    eventType: 'goal',
    eventSubtype: 'own_goal'
  }
});
```

### 查询普通进球（排除乌龙球）

```javascript
const { Op } = require('sequelize');

const normalGoals = await MatchEvent.findAll({
  where: {
    matchId: matchId,
    eventType: 'goal',
    [Op.or]: [
      { eventSubtype: null },
      { eventSubtype: { [Op.ne]: 'own_goal' } }
    ]
  }
});
```

### 统计球员进球数（排除乌龙球）

```javascript
const playerGoals = await MatchEvent.count({
  where: {
    userId: playerId,
    eventType: 'goal',
    [Op.or]: [
      { eventSubtype: null },
      { eventSubtype: { [Op.ne]: 'own_goal' } }
    ]
  }
});
```

### 查询某场比赛的各类进球

```javascript
const goalsByType = await MatchEvent.findAll({
  where: {
    matchId: matchId,
    eventType: 'goal'
  },
  attributes: [
    'eventSubtype',
    [sequelize.fn('COUNT', sequelize.col('id')), 'count']
  ],
  group: ['eventSubtype']
});

// 结果示例：
// [
//   { eventSubtype: null, count: 5 },          // 普通进球：5个
//   { eventSubtype: 'own_goal', count: 1 },    // 乌龙球：1个
//   { eventSubtype: 'penalty', count: 2 },     // 点球：2个
//   { eventSubtype: 'header', count: 3 }       // 头球：3个
// ]
```

## 统计规则

### ✅ 计入个人进球数

- 普通进球（`eventSubtype = null`）
- 点球（`eventSubtype = 'penalty'`）
- 任意球（`eventSubtype = 'free_kick'`）
- 头球（`eventSubtype = 'header'`）
- 等等...

### ❌ 不计入个人进球数

- 乌龙球（`eventSubtype = 'own_goal'`）

### 比分计算规则

无论进球类型如何，都计入比赛比分：
- 普通进球：计入己方比分
- 乌龙球：计入**对方**比分

## 前端展示建议

### 比赛事件列表

```
15' ⚽ 张三 进球 (头球)
35' ⚽ 李四 进球 (乌龙球) 🔴
42' ⚽ 王五 进球
78' ⚽ 赵六 进球 (点球)
```

### 球员进球统计卡片

```
张三
━━━━━━━━━━━━━━━
总进球: 15 球
 - 普通进球: 10 球
 - 点球: 3 球
 - 头球: 2 球
 - 任意球: 0 球
⚠️ 乌龙球: 1 球（不计入进球数）
```

## 注意事项

1. **乌龙球记录规则**：
   - `teamId` 必须是踢乌龙球球员**自己的队伍**
   - `eventSubtype` 必须设置为 `'own_goal'`
   - 比分计入对方，但球员个人进球数不增加

2. **统计查询时的排除**：
   - 查询球员进球数时，务必排除 `eventSubtype = 'own_goal'`
   - 使用条件：`eventSubtype IS NULL OR eventSubtype != 'own_goal'`

3. **扩展性**：
   - 未来可以继续添加新的子类型，无需修改数据库结构
   - 只需约定好新的 `event_subtype` 值即可

4. **向后兼容**：
   - 旧数据 `eventSubtype` 为 `NULL`，代表普通进球
   - 不影响现有统计逻辑

## 数据库查询性能

`event_subtype` 字段已添加索引：

```sql
INDEX idx_event_subtype (event_subtype)
```

查询性能优化建议：
- 使用索引字段进行筛选
- 避免在 `event_subtype` 上使用函数
- 合理使用 `IS NULL` 和 `= 'value'` 组合条件

## 总结

通过 `event_subtype` 字段，系统现在可以：

✅ 区分乌龙球和普通进球
✅ 记录各种进球方式（点球、任意球、头球等）
✅ 统计时正确排除乌龙球
✅ 灵活扩展新的事件子类型
✅ 不影响现有数据和统计逻辑

这种设计方式兼顾了**灵活性、扩展性和查询性能**，是最佳实践！
