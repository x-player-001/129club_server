# ä¹Œé¾™çƒåŠŸèƒ½è¯´æ˜æ–‡æ¡£

## åŠŸèƒ½æ¦‚è¿°

ç³»ç»Ÿç°å·²æ”¯æŒè®°å½•ä¹Œé¾™çƒï¼ˆOwn Goalï¼‰ä»¥åŠå…¶ä»–å„ç§è¿›çƒç±»å‹ã€‚é€šè¿‡ `event_subtype` å­—æ®µï¼Œå¯ä»¥è®°å½•è¿›çƒçš„è¯¦ç»†æ–¹å¼ã€‚

## æ•°æ®åº“è®¾è®¡

### match_events è¡¨æ–°å¢å­—æ®µ

```sql
event_subtype VARCHAR(50) NULL
COMMENT 'äº‹ä»¶å­ç±»å‹ï¼ˆown_goal=ä¹Œé¾™çƒ, penalty=ç‚¹çƒ, free_kick=ä»»æ„çƒ, header=å¤´çƒç­‰ï¼‰'
```

### è®¾è®¡ä¼˜åŠ¿

âœ… **é«˜æ‰©å±•æ€§**ï¼šå¯ä»¥æ— é™æ·»åŠ æ–°çš„å­ç±»å‹ï¼Œæ— éœ€ä¿®æ”¹è¡¨ç»“æ„
âœ… **å±‚æ¬¡æ¸…æ™°**ï¼š`event_type` æ˜¯å¤§ç±»ï¼Œ`event_subtype` æ˜¯ç»†åˆ†
âœ… **çµæ´»æŸ¥è¯¢**ï¼šå¯ä»¥æŸ¥è¯¢æ‰€æœ‰è¿›çƒï¼Œæˆ–ç‰¹å®šç±»å‹çš„è¿›çƒ
âœ… **æ”¯æŒç»„åˆ**ï¼šåŒä¸€ä¸ªäº‹ä»¶ç±»å‹å¯ä»¥æœ‰å¤šç§å­ç±»å‹

## æ”¯æŒçš„äº‹ä»¶å­ç±»å‹

### è¿›çƒç±»å‹ (`event_type = 'goal'`)

| event_subtype | ä¸­æ–‡åç§° | è¯´æ˜ |
|---------------|---------|------|
| `own_goal` | ä¹Œé¾™çƒ | çƒå‘˜å°†çƒè¸¢è¿›è‡ªå·±çƒé—¨ |
| `penalty` | ç‚¹çƒ | 12ç ç‚¹çƒ |
| `free_kick` | ä»»æ„çƒ | ç›´æ¥ä»»æ„çƒç ´é—¨ |
| `corner_kick` | è§’çƒ | è§’çƒç›´æ¥ç ´é—¨ |
| `header` | å¤´çƒ | å¤´çƒè¿›çƒ |
| `volley` | å‡Œç©ºæŠ½å°„ | å‡Œç©ºæŠ½å°„è¿›çƒ |
| `bicycle_kick` | å€’é’© | å€’é’©è¿›çƒ |
| `long_shot` | è¿œå°„ | è·ç¦»çƒé—¨è¾ƒè¿œçš„å°„é—¨ |
| `null` | æ™®é€šè¿›çƒ | æœªæŒ‡å®šå­ç±»å‹çš„è¿›çƒ |

### çŠ¯è§„ç±»å‹ (`event_type = 'yellow_card'` / `'red_card'`)

| event_subtype | ä¸­æ–‡åç§° | è¯´æ˜ |
|---------------|---------|------|
| `foul` | çŠ¯è§„ | ä¸€èˆ¬çŠ¯è§„ |
| `diving` | å‡æ‘” | å‡æ‘”éª—ç‰Œ |
| `dissent` | å¼‚è®® | å¯¹è£åˆ¤åˆ¤ç½šè¡¨ç¤ºå¼‚è®® |
| `violent_conduct` | æš´åŠ›è¡Œä¸º | æš´åŠ›è¡Œä¸º |
| `second_yellow` | ä¸¤é»„å˜çº¢ | ç¬¬äºŒå¼ é»„ç‰Œç´¯è®¡çº¢ç‰Œ |

## API ä½¿ç”¨ç¤ºä¾‹

### 1. è®°å½•ä¹Œé¾™çƒ

```javascript
POST /api/match/:matchId/event

{
  "teamId": "ball-owner-team-id",     // è¸¢ä¹Œé¾™çƒçƒå‘˜æ‰€åœ¨çš„é˜Ÿä¼
  "userId": "player-user-id",          // è¸¢ä¹Œé¾™çƒçš„çƒå‘˜ID
  "eventType": "goal",                 // äº‹ä»¶ç±»å‹ï¼šè¿›çƒ
  "eventSubtype": "own_goal",          // å­ç±»å‹ï¼šä¹Œé¾™çƒ
  "minute": 35,
  "notes": "ç¦åŒºå†…è§£å›´å¤±è¯¯"
}
```

**é‡è¦**ï¼š
- `teamId` æ˜¯è¸¢ä¹Œé¾™çƒçƒå‘˜**è‡ªå·±çš„é˜Ÿä¼ID**ï¼ˆä¸æ˜¯è¿›çƒæ–¹ï¼‰
- ä¹Œé¾™çƒè®¡å…¥å¯¹æ–¹æ¯”åˆ†ï¼Œä½†ä¸è®¡å…¥è¯¥çƒå‘˜çš„è¿›çƒæ•°

### 2. è®°å½•ç‚¹çƒ

```javascript
POST /api/match/:matchId/event

{
  "teamId": "team-id",
  "userId": "player-user-id",
  "eventType": "goal",
  "eventSubtype": "penalty",           // å­ç±»å‹ï¼šç‚¹çƒ
  "minute": 78,
  "assistUserId": null,                // ç‚¹çƒé€šå¸¸æ²¡æœ‰åŠ©æ”»
  "notes": "ç‚¹çƒå‘½ä¸­"
}
```

### 3. è®°å½•å¤´çƒ

```javascript
POST /api/match/:matchId/event

{
  "teamId": "team-id",
  "userId": "player-user-id",
  "eventType": "goal",
  "eventSubtype": "header",            // å­ç±»å‹ï¼šå¤´çƒ
  "minute": 15,
  "assistUserId": "assist-player-id",
  "notes": "è§’çƒå¤´çƒæ”»é—¨"
}
```

### 4. è®°å½•æ™®é€šè¿›çƒï¼ˆæ— å­ç±»å‹ï¼‰

```javascript
POST /api/match/:matchId/event

{
  "teamId": "team-id",
  "userId": "player-user-id",
  "eventType": "goal",
  "eventSubtype": null,                // æˆ–è€…ä¸ä¼ æ­¤å­—æ®µ
  "minute": 42,
  "assistUserId": "assist-player-id"
}
```

## æŸ¥è¯¢ç¤ºä¾‹

### æŸ¥è¯¢æ‰€æœ‰è¿›çƒï¼ˆåŒ…æ‹¬ä¹Œé¾™çƒï¼‰

```javascript
const allGoals = await MatchEvent.findAll({
  where: {
    matchId: matchId,
    eventType: 'goal'
  }
});
```

### åªæŸ¥è¯¢ä¹Œé¾™çƒ

```javascript
const ownGoals = await MatchEvent.findAll({
  where: {
    matchId: matchId,
    eventType: 'goal',
    eventSubtype: 'own_goal'
  }
});
```

### æŸ¥è¯¢æ™®é€šè¿›çƒï¼ˆæ’é™¤ä¹Œé¾™çƒï¼‰

```javascript
const { Op } = require('sequelize');

const normalGoals = await MatchEvent.findAll({
  where: {
    matchId: matchId,
    eventType: 'goal',
    [Op.or]: [
      { eventSubtype: null },
      { eventSubtype: { [Op.ne]: 'own_goal' } }
    ]
  }
});
```

### ç»Ÿè®¡çƒå‘˜è¿›çƒæ•°ï¼ˆæ’é™¤ä¹Œé¾™çƒï¼‰

```javascript
const playerGoals = await MatchEvent.count({
  where: {
    userId: playerId,
    eventType: 'goal',
    [Op.or]: [
      { eventSubtype: null },
      { eventSubtype: { [Op.ne]: 'own_goal' } }
    ]
  }
});
```

### æŸ¥è¯¢æŸåœºæ¯”èµ›çš„å„ç±»è¿›çƒ

```javascript
const goalsByType = await MatchEvent.findAll({
  where: {
    matchId: matchId,
    eventType: 'goal'
  },
  attributes: [
    'eventSubtype',
    [sequelize.fn('COUNT', sequelize.col('id')), 'count']
  ],
  group: ['eventSubtype']
});

// ç»“æœç¤ºä¾‹ï¼š
// [
//   { eventSubtype: null, count: 5 },          // æ™®é€šè¿›çƒï¼š5ä¸ª
//   { eventSubtype: 'own_goal', count: 1 },    // ä¹Œé¾™çƒï¼š1ä¸ª
//   { eventSubtype: 'penalty', count: 2 },     // ç‚¹çƒï¼š2ä¸ª
//   { eventSubtype: 'header', count: 3 }       // å¤´çƒï¼š3ä¸ª
// ]
```

## ç»Ÿè®¡è§„åˆ™

### âœ… è®¡å…¥ä¸ªäººè¿›çƒæ•°

- æ™®é€šè¿›çƒï¼ˆ`eventSubtype = null`ï¼‰
- ç‚¹çƒï¼ˆ`eventSubtype = 'penalty'`ï¼‰
- ä»»æ„çƒï¼ˆ`eventSubtype = 'free_kick'`ï¼‰
- å¤´çƒï¼ˆ`eventSubtype = 'header'`ï¼‰
- ç­‰ç­‰...

### âŒ ä¸è®¡å…¥ä¸ªäººè¿›çƒæ•°

- ä¹Œé¾™çƒï¼ˆ`eventSubtype = 'own_goal'`ï¼‰

### æ¯”åˆ†è®¡ç®—è§„åˆ™

æ— è®ºè¿›çƒç±»å‹å¦‚ä½•ï¼Œéƒ½è®¡å…¥æ¯”èµ›æ¯”åˆ†ï¼š
- æ™®é€šè¿›çƒï¼šè®¡å…¥å·±æ–¹æ¯”åˆ†
- ä¹Œé¾™çƒï¼šè®¡å…¥**å¯¹æ–¹**æ¯”åˆ†

## å‰ç«¯å±•ç¤ºå»ºè®®

### æ¯”èµ›äº‹ä»¶åˆ—è¡¨

```
15' âš½ å¼ ä¸‰ è¿›çƒ (å¤´çƒ)
35' âš½ æå›› è¿›çƒ (ä¹Œé¾™çƒ) ğŸ”´
42' âš½ ç‹äº” è¿›çƒ
78' âš½ èµµå…­ è¿›çƒ (ç‚¹çƒ)
```

### çƒå‘˜è¿›çƒç»Ÿè®¡å¡ç‰‡

```
å¼ ä¸‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
æ€»è¿›çƒ: 15 çƒ
 - æ™®é€šè¿›çƒ: 10 çƒ
 - ç‚¹çƒ: 3 çƒ
 - å¤´çƒ: 2 çƒ
 - ä»»æ„çƒ: 0 çƒ
âš ï¸ ä¹Œé¾™çƒ: 1 çƒï¼ˆä¸è®¡å…¥è¿›çƒæ•°ï¼‰
```

## æ³¨æ„äº‹é¡¹

1. **ä¹Œé¾™çƒè®°å½•è§„åˆ™**ï¼š
   - `teamId` å¿…é¡»æ˜¯è¸¢ä¹Œé¾™çƒçƒå‘˜**è‡ªå·±çš„é˜Ÿä¼**
   - `eventSubtype` å¿…é¡»è®¾ç½®ä¸º `'own_goal'`
   - æ¯”åˆ†è®¡å…¥å¯¹æ–¹ï¼Œä½†çƒå‘˜ä¸ªäººè¿›çƒæ•°ä¸å¢åŠ 

2. **ç»Ÿè®¡æŸ¥è¯¢æ—¶çš„æ’é™¤**ï¼š
   - æŸ¥è¯¢çƒå‘˜è¿›çƒæ•°æ—¶ï¼ŒåŠ¡å¿…æ’é™¤ `eventSubtype = 'own_goal'`
   - ä½¿ç”¨æ¡ä»¶ï¼š`eventSubtype IS NULL OR eventSubtype != 'own_goal'`

3. **æ‰©å±•æ€§**ï¼š
   - æœªæ¥å¯ä»¥ç»§ç»­æ·»åŠ æ–°çš„å­ç±»å‹ï¼Œæ— éœ€ä¿®æ”¹æ•°æ®åº“ç»“æ„
   - åªéœ€çº¦å®šå¥½æ–°çš„ `event_subtype` å€¼å³å¯

4. **å‘åå…¼å®¹**ï¼š
   - æ—§æ•°æ® `eventSubtype` ä¸º `NULL`ï¼Œä»£è¡¨æ™®é€šè¿›çƒ
   - ä¸å½±å“ç°æœ‰ç»Ÿè®¡é€»è¾‘

## æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½

`event_subtype` å­—æ®µå·²æ·»åŠ ç´¢å¼•ï¼š

```sql
INDEX idx_event_subtype (event_subtype)
```

æŸ¥è¯¢æ€§èƒ½ä¼˜åŒ–å»ºè®®ï¼š
- ä½¿ç”¨ç´¢å¼•å­—æ®µè¿›è¡Œç­›é€‰
- é¿å…åœ¨ `event_subtype` ä¸Šä½¿ç”¨å‡½æ•°
- åˆç†ä½¿ç”¨ `IS NULL` å’Œ `= 'value'` ç»„åˆæ¡ä»¶

## æ€»ç»“

é€šè¿‡ `event_subtype` å­—æ®µï¼Œç³»ç»Ÿç°åœ¨å¯ä»¥ï¼š

âœ… åŒºåˆ†ä¹Œé¾™çƒå’Œæ™®é€šè¿›çƒ
âœ… è®°å½•å„ç§è¿›çƒæ–¹å¼ï¼ˆç‚¹çƒã€ä»»æ„çƒã€å¤´çƒç­‰ï¼‰
âœ… ç»Ÿè®¡æ—¶æ­£ç¡®æ’é™¤ä¹Œé¾™çƒ
âœ… çµæ´»æ‰©å±•æ–°çš„äº‹ä»¶å­ç±»å‹
âœ… ä¸å½±å“ç°æœ‰æ•°æ®å’Œç»Ÿè®¡é€»è¾‘

è¿™ç§è®¾è®¡æ–¹å¼å…¼é¡¾äº†**çµæ´»æ€§ã€æ‰©å±•æ€§å’ŒæŸ¥è¯¢æ€§èƒ½**ï¼Œæ˜¯æœ€ä½³å®è·µï¼
